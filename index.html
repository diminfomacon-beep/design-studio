<!-- Fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<script>
const KEY = 'Z-a_ubE9NWNeF8tLL7QM4LjHdrIW7_RE0ZHUWAUi_zU';

let canvas;

window.onload = function () {
    canvas = new fabric.Canvas('studio');
    console.log("Studio Ready!");
};

function addText() {
    const t = new fabric.IText('Edit Me', { left: 50, top: 50 });
    canvas.add(t);
}

async function searchUnsplash() {
    const q = document.getElementById('query').value;
    const url = `https://api.unsplash.com/search/photos?query=${q}&client_id=${KEY}&per_page=6`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        const tray = document.getElementById('results');
        tray.innerHTML = '';

        data.results.forEach(photo => {
            const img = document.createElement('img');
            img.src = photo.urls.thumb;
            img.style.height = "70px";
            img.style.cursor = "pointer";

            img.onclick = () => {
                fabric.Image.fromURL(photo.urls.regular, function(fImg) {
                    fImg.scaleToWidth(200);
                    canvas.add(fImg);
                    canvas.renderAll();
                }, { crossOrigin: 'anonymous' });
            };

            tray.appendChild(img);
        });

    } catch (e) {
        console.error("Search failed:", e);
        alert("Check your API key or hosting environment.");
    }
}

function deleteObj() {
    const active = canvas.getActiveObjects();
    active.forEach(obj => canvas.remove(obj));
    canvas.discardActiveObject();
    canvas.renderAll();
}

function download() {
    canvas.discardActiveObject();
    canvas.renderAll();
    const link = document.createElement('a');
    link.download = 'design.png';
    link.href = canvas.toDataURL({ format: 'png', multiplier: 2 });
    link.click();
}
</script>
