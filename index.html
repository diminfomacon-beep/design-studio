<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>D.I.M. Bright Ideas – Design Studio</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f4f4f4;
}
header{
    background:#0C264D;
    color:white;
    padding:15px;
    text-align:center;
    font-size:20px;
}
.container{
    display:flex;
    flex-wrap:wrap;
}
.controls{
    width:320px;
    background:white;
    padding:15px;
    box-shadow:0 0 10px rgba(0,0,0,.1);
}
.controls input, .controls select{
    width:100%;
    padding:8px;
    margin-bottom:8px;
}
.controls button{
    width:100%;
    padding:10px;
    margin-bottom:8px;
    border:none;
    cursor:pointer;
    border-radius:4px;
    background:#044499;
    color:white;
}
.controls button.green{background:#28a745;}
.controls button.orange{background:#ED7800;}
.controls button.red{background:#c82333;}

.canvas-area{
    flex:1;
    text-align:center;
    padding:20px;
}
#canvas-wrap{
    background:white;
    display:inline-block;
}
</style>
</head>

<body>

<header>D.I.M. Bright Ideas – Custom Design Studio</header>

<div class="container">

<div class="controls">

<h3>Select Product</h3>
<select id="productSelect" onchange="switchProduct()">
    <option value="shirt">T-Shirt</option>
    <option value="tumbler">Tumbler</option>
    <option value="tote">Tote Bag</option>
    <option value="mug">Mug</option>
</select>

<h3>Add Text</h3>
<input type="text" id="textInput" placeholder="Enter text">
<input type="color" id="fontColor" value="#000000">
<input type="number" id="fontSize" value="40">
<button onclick="addText()">Add Text</button>

<h3>Upload Logo</h3>
<input type="file" id="upload" accept="image/*">

<h3>AI Image Generator</h3>
<input type="text" id="aiPrompt" placeholder="Describe your design...">
<button class="orange" onclick="generateAI()">Generate AI Image</button>

<h3>Edit Image</h3>
<button onclick="removeBackground()">Remove Background</button>
<button onclick="deleteObj()" class="red">Delete Selected</button>

<h3>Download</h3>
<button class="green" onclick="download()">Download Design</button>

</div>

<div class="canvas-area">
<div id="canvas-wrap">
<canvas id="studio" width="700" height="700"></canvas>
</div>
</div>

</div>

<script>

const BACKEND_URL = "https://design-studio-pii9hp9ib-diminfomacon-3561s-projects.vercel.app";

let canvas = new fabric.Canvas('studio', {
    preserveObjectStacking:true
});

let printArea;
let currentMockup;

const products = {
    shirt: {
        mockup: "mockups/shirt.png",
        printArea: {left:200, top:250, width:300, height:350}
    },
    tumbler: {
        mockup: "mockups/tumbler.png",
        printArea: {left:250, top:150, width:200, height:400}
    },
    tote: {
        mockup: "mockups/tote.png",
        printArea: {left:220, top:200, width:260, height:300}
    },
    mug: {
        mockup: "mockups/mug.png",
        printArea: {left:200, top:280, width:300, height:200}
    }
};

function switchProduct(){
    const selected = document.getElementById("productSelect").value;
    loadProduct(products[selected]);
}

function loadProduct(product){

    canvas.clear();

    fabric.Image.fromURL(product.mockup,function(img){
        img.scaleToWidth(700);
        img.selectable=false;
        img.evented=false;
        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
    }):

    printArea = new fabric.Rect({
        left:product.printArea.left,
        top:product.printArea.top,
        width:product.printArea.width,
        height:product.printArea.height,
        fill:"transparent",
        stroke:"red",
        strokeDashArray:[5,5],
        selectable:false,
        evented:false
    });

    canvas.add(printArea);
}

loadProduct(products.shirt);

// Add Text
function addText(){
    const text = new fabric.IText(
        document.getElementById("textInput").value || "Your Text",
        {
            left:printArea.left + 20,
            top:printArea.top + 20,
            fill:document.getElementById("fontColor").value,
            fontSize:parseInt(document.getElementById("fontSize").value)
        }
    );
    canvas.add(text);
}

// Upload Image
document.getElementById("upload").addEventListener("change",function(e){
    const reader=new FileReader();
    reader.onload=function(f){
        fabric.Image.fromURL(f.target.result,function(img){
            img.scaleToWidth(200);
            img.left=printArea.left + 20;
            img.top=printArea.top + 20;
            canvas.add(img);
        });
    };
    reader.readAsDataURL(e.target.files[0]);
});

// Delete
function deleteObj(){
    canvas.getActiveObjects().forEach(obj => {
        if(obj !== printArea) canvas.remove(obj);
    });
    canvas.discardActiveObject();
    canvas.renderAll();
}

// Download
function download(){
    canvas.discardActiveObject();
    canvas.renderAll();
    const link=document.createElement("a");
    link.download="DIM_Design.png";
    link.href=canvas.toDataURL({format:"png",multiplier:3});
    link.click();
}

// Remove Background
async function removeBackground(){
    const obj=canvas.getActiveObject();
    if(!obj || obj.type!=="image") return alert("Select an image");

    const res=await fetch(`${BACKEND_URL}/api/removebg`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({image:obj._element.src})
    });

    const data=await res.json();

    fabric.Image.fromURL(data.url,function(img){
        img.scaleToWidth(obj.width);
        img.left=obj.left;
        img.top=obj.top;
        canvas.remove(obj);
        canvas.add(img);
    });
}

// AI Generator
async function generateAI(){
    const prompt=document.getElementById("aiPrompt").value;

    const res=await fetch(`${BACKEND_URL}/api/generate`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({prompt})
    });

    const data=await res.json();

    fabric.Image.fromURL(data.url,function(img){
        img.scaleToWidth(250);
        img.left=printArea.left + 20;
        img.top=printArea.top + 20;
        canvas.add(img);
    });
}

</script>
</body>
</html>
